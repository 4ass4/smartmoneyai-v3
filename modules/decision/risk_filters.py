# modules/decision/risk_filters.py


def apply_risk_filters(signals, confidence):
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∏—Å–∫–∞ –∫ —Å–∏–≥–Ω–∞–ª—É
    
    Args:
        signals: —Å–ª–æ–≤–∞—Ä—å —Å–æ –≤—Å–µ–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏
        confidence: —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (0-10)
        
    Returns:
        Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    """
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π confidence –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏
    # –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
    # 5.5+ = —Ö–æ—Ä–æ—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã (SVD + liquidity + structure)
    # 4.0-5.5 = —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (–º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã)
    # <4.0 = –æ—á–µ–Ω—å —Å–ª–∞–±—ã–µ —Å–∏–≥–Ω–∞–ª—ã (–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è)
    MIN_CONFIDENCE = 4.0  # –°–Ω–∏–∂–µ–Ω —Å 5.5 –¥–ª—è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ì–û –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
    if confidence < MIN_CONFIDENCE:
        return {
            "allowed": False,
            "reason": f"–°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞ ({confidence:.1f} < {MIN_CONFIDENCE})"
        }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å–∏–≥–Ω–∞–ª–æ–≤
    # (—Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ –º—è–≥–∫–∞—è - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç)
    liq_dir = signals["liquidity"].get("direction", {}).get("direction", "neutral")
    svd_intent = signals["svd"].get("intent", "unclear")
    trend = signals["structure"].get("trend", "range")
    signal_type = signals.get("signal", "WAIT")
    
    # –°–¢–†–û–ì–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
    # –ö–∏—Ç—ã = –≥–ª–∞–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä. –ù–ï–õ–¨–ó–Ø –∏–¥—Ç–∏ –ø—Ä–æ—Ç–∏–≤ –∫–∏—Ç–æ–≤!
    
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ù–§–õ–ò–ö–¢ #1: BUY –∫–æ–≥–¥–∞ –∫–∏—Ç—ã –ü–†–û–î–ê–Æ–¢
    if signal_type == "BUY" and svd_intent == "distributing":
        return {
            "allowed": False,
            "reason": "üö´ –û–ü–ê–°–ù–û: BUY –∫–æ–≥–¥–∞ –∫–∏—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç (CVD –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π). –†–∏—Å–∫ —Å–ª–∏–≤–∞!"
        }
    
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ù–§–õ–ò–ö–¢ #2: SELL –∫–æ–≥–¥–∞ –∫–∏—Ç—ã –ü–û–ö–£–ü–ê–Æ–¢
    if signal_type == "SELL" and svd_intent == "accumulating":
        return {
            "allowed": False,
            "reason": "üö´ –û–ü–ê–°–ù–û: SELL –∫–æ–≥–¥–∞ –∫–∏—Ç—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç (CVD –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π). –†–∏—Å–∫ —Å–ª–∏–≤–∞!"
        }
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (–º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ, –Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º)
    minor_conflicts = 0
    
    # –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ: —Å–∏–≥–Ω–∞–ª BUY, –Ω–æ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –≤–Ω–∏–∑
    if signal_type == "BUY" and liq_dir == "down":
        minor_conflicts += 1
    
    # –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ: —Å–∏–≥–Ω–∞–ª SELL, –Ω–æ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –≤–≤–µ—Ä—Ö
    if signal_type == "SELL" and liq_dir == "up":
        minor_conflicts += 1
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω–æ—Ä–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
    if minor_conflicts >= 1:
        return {
            "allowed": False,
            "reason": f"–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (minor conflicts: {minor_conflicts})"
        }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å
    ta_data = signals.get("ta", {})
    if ta_data.get("overbought") and signals.get("signal") == "BUY":
        return {
            "allowed": False,
            "reason": "–†—ã–Ω–æ–∫ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–∫—É–ø–∫–∞"
        }
    
    if ta_data.get("oversold") and signals.get("signal") == "SELL":
        return {
            "allowed": False,
            "reason": "–†—ã–Ω–æ–∫ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∂–∞"
        }
    
    return {
        "allowed": True,
        "reason": "–°–∏–≥–Ω–∞–ª –ø—Ä–æ—à–µ–ª –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã"
    }

